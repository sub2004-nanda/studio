
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check the role of the currently authenticated user.
    // It reads the 'role' field from the user's own document in the 'users' collection.
    function isRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Admins can perform any action on any user document.
      allow read, write, list: if isRole('admin');
      
      // A non-admin user can only read or update their own user document.
      allow read, update: if request.auth.uid == userId;
    }

    // Rules for the 'departments' collection
    match /departments/{departmentId} {
      // Only admins can create new departments.
      allow create: if isRole('admin');
    }
  }
}
